http://linux-ip.net/html/tools-ip-route.html

Д.2. **IP-маршрут**

[Пред.](http://linux-ip.net/html/tools-route.html) 

Приложение D. Управление IP-маршрутом

 [Следующий](http://linux-ip.net/html/tools-ip-rule.html)

---

## Д.2. **IP-маршрут**

Еще одна часть набора инструментов **iproute2 для управления IP,** **ip route** предоставляет инструменты управления для манипулирования любой из таблиц маршрутизации. Операции включают [отображение маршрутов](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show "Д.2.1.  Отображение таблицы маршрутизации с ip route show") или [кэша маршрутизации](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show-cache "Г.2.2.  Отображение кеша маршрутизации с ip route show cache") , [добавление маршрутов](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-add "Д.2.3.  Использование ip route add для заполнения таблицы маршрутизации") , [удаление маршрутов](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-del "Д.2.6.  Удаление маршрутов с помощью ip route del") , [изменение существующих маршрутов](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-change "Д.2.7.  Изменение существующих маршрутов с изменением IP-маршрута") , [выборку маршрута](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-get "Д.2.8.  Программное получение информации о маршруте с помощью ip route get") и [очистку всей таблицы маршрутизации или кэша маршрутизации](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-flush "Д.2.9.  Очистка таблиц маршрутизации с помощью ip route flush") .

**При использовании ip route** следует помнить, что с помощью этой команды вы можете работать с любой из 255 таблиц маршрутизации. Там, где команда [**route**](http://linux-ip.net/html/tools-route.html "Д.1.  маршрут") работала только с основной таблицей маршрутизации (таблица 254), команда **ip route** работает по умолчанию с основной таблицей маршрутизации, но ее можно легко заставить использовать другие таблицы с параметром `table`.

К счастью, как упоминалось ранее, набор инструментов **iproute2** не использует DNS для каких-либо операций, поэтому вездесущий `-n`переключатель из предыдущих примеров не потребуется ни в одном из примеров.

Все операции с командой **ip route** атомарны, поэтому каждая команда вернет либо `RTNETLINK answers: No such process`в случае ошибки, либо ничего в случае успеха. Коммутатор `-s`, который предоставляет дополнительную статистическую информацию при сообщении информации об уровне канала, будет предоставлять дополнительную информацию только при сообщении о состоянии кэша [маршрутизации](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show-cache "Г.2.2.  Отображение кеша маршрутизации с ip route show cache") или [выборке определенного маршрута](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-get "Д.2.8.  Программное получение информации о маршруте с помощью ip route get") .

Утилита **ip route** при использовании в сочетании с утилитой [**ip rule**](http://linux-ip.net/html/tools-ip-rule.html "Д.3.  IP-правило") может создавать таблицы NAT без сохранения состояния. Он может даже манипулировать локальной таблицей маршрутизации, таблицей маршрутизации, используемой для трафика, привязанного к широковещательным адресам и IP-адресам, размещенным на самой машине.

Чтобы понять контекст, в котором работает этот инструмент, вам необходимо понять некоторые основы IP-маршрутизации, поэтому, если вы прочитали приведенное выше введение в инструмент ip route **и** запутались, вы можете прочитать [главу 4, _IP-маршрутизация_](http://linux-ip.net/html/ch-routing.html "Глава 4. IP-маршрутизация") и ознакомьтесь с некоторыми концепциями IP-маршрутизации (в Linux), прежде чем продолжить.

### Д.2.1. Отображение таблицы маршрутизации с **ip route show**

В простейшей форме **ip route** можно использовать для отображения выходных данных основной таблицы маршрутизации. Вывод этой команды существенно отличается от вывода [**route**](http://linux-ip.net/html/tools-route.html#tools-route-show "Д.1.1.  Отображение таблицы маршрутизации с маршрутом") . Для сравнения давайте посмотрим на вывод как **route -n** , так и **ip route show** .

**Пример Г.11. Просмотр основной таблицы маршрутизации с ip route show**

```
[root@tristan]# 
```

  

Если вы привыкли к формату вывода **маршрута** , вывод **ip route** может показаться кратким. Однако отображается та же основная информация. Как и в нашем предыдущем примере, давайте на данный момент проигнорируем петлевой маршрут 127.0.0.0/8. Это обязательный маршрут для любых IP-адресов, размещенных на петлевом интерфейсе. Нас гораздо больше интересуют два других маршрута.

Сеть 192.168.99.0/24 доступна на eth0 с областью ссылки, что означает, что сеть действительна и доступна через это устройство (eth0). Обратитесь к [Таблице C.2, «Область IP по IP-адресу »](http://linux-ip.net/html/tools-ip-address.html#tb-tools-ip-addr-scope "Таблица С.2.  Область IP по IP-адресу") для определения возможных областей. Пока связь на этом устройстве остается хорошей, мы сможем получить доступ к любому IP-адресу внутри 192.168.99.0/24 через интерфейс eth0.

Наконец, наш самый важный маршрут по умолчанию выражается в таблице маршрутизации словом default. Обратите внимание, что любой пункт назначения, доступный через шлюз, отображается в выходных данных таблицы маршрутизации с ключевым словом `via`. Эта последняя строка семантически совпадает с последней строкой вывода **маршрута -n** выше.

Теперь давайте посмотрим на локальную таблицу маршрутизации, которую мы не можем увидеть с помощью **route** . Честно говоря, обычно совершенно необязательно просматривать и/или манипулировать локальной таблицей маршрутизации, поэтому **route** не предоставляет доступа к этой информации.

**Пример Г.12. Просмотр локальной таблицы маршрутизации с помощью ip route show table local**

```
[root@tristan]# 
```

  

Это дает нам большой объем информации об IP-сетях, к которым машина напрямую подключена, и позволяет взглянуть изнутри на то, как таблицы маршрутизации обрабатывают специальные адреса, такие как широковещательные адреса и локально сконфигурированные адреса.

Первое поле в этом выводе сообщает нам, предназначен ли маршрут для широковещательного адреса или IP-адреса или диапазона, локально размещенного на этой машине. Последующие поля сообщают нам, через какое устройство достижим пункт назначения, и особенно (в этой таблице) о том, что ядро ​​добавило эти маршруты как часть создания интерфейсов уровня IP.

Для каждого IP-адреса, размещенного на машине, имеет смысл, что машина должна ограничивать доступ к этому IP-адресу или диапазону IP-адресов только для себя. Это объясняет, почему в [примере D.12, «Просмотр локальной таблицы маршрутизации с помощью ip route show table local »](http://linux-ip.net/html/tools-ip-route.html#ex-tools-ip-route-show-local "Пример Г.12.  Просмотр локальной таблицы маршрутизации с помощью ip route show table local") , 192.168.99.35 имеет область хоста. Поскольку `tristan`этот IP-адрес хоста, нет причин для маршрутизации пакета. Точно так же нет необходимости перенаправлять адресата localhost (127.0.0.1) с этой машины. В каждом из этих случаев область действия была установлена ​​на host.

Для широковещательных адресов, которые предназначены для любых слушателей, которые совместно используют IP-сеть, пункт назначения имеет смысл только для набора устройств, подключенных к одному и тому же канальному уровню [[49]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855371744) .

Последней характеристикой, доступной нам в каждой строке вывода локальной таблицы маршрутизации, является `src`ключевое слово. Это рассматривается как подсказка ядру о том, какой IP-адрес выбрать в качестве исходного адреса для исходящих пакетов на этом интерфейсе. Естественно, это чаще всего используется (и злоупотребляется) на многосетевых хостах, хотя почти каждая машина использует эту подсказку для соединений с локальным хостом [[50]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855369408) .

Теперь, когда мы изучили основную таблицу маршрутизации и локальную таблицу маршрутизации, давайте посмотрим, насколько легко можно просмотреть любую из других таблиц маршрутизации. Это так же просто, как указать таблицу по имени `/etc/iproute2/rt_tables`или по номеру. В этом файле есть несколько зарезервированных идентификаторов таблиц, но другие номера таблиц от 1 до 252 доступны для пользователя. Обратите внимание, что этот пример предназначен только для демонстрации и не имеет внутренней ценности, кроме демонстрации использования параметра `table`.

**Пример Г.13. Просмотр таблицы маршрутизации с ip route show table**

```
[root@tristan]# 
```

  

В приведенном выше примере вы впервые видите, как добавить маршрут в таблицу, отличную от основной таблицы маршрутизации, но что нас действительно интересует, так это окончательная команда и вывод. В [Примере D.13 «Просмотр таблицы маршрутизации с помощью таблицы ip route show »](http://linux-ip.net/html/tools-ip-route.html#ex-tools-ip-route-show-table "Пример Г.13.  Просмотр таблицы маршрутизации с ip route show table") мы идентифицировали таблицу 7 по имени «специальная» и добавили маршрут в эту таблицу. Команда **`ip route show table special`**показывает нам таблицу маршрутизации номер 7 из ядра.

**ip route** консультируется `/etc/iproute2/rt_tables`для идентификатора таблицы. Если он не находит идентификатора, он жалуется, что не может найти ссылку на такую ​​таблицу. Если идентификатор таблицы найден, отображается соответствующая таблица маршрутизации.

Использование нескольких таблиц маршрутизации может очень быстро сделать маршрутизатор очень сложным. Использование имен вместо номеров для этих таблиц может помочь справиться с этой сложностью. Для дальнейшего обсуждения управления несколькими таблицами маршрутизации и некоторых вопросов их обработки см. [Раздел 10.3, «Использование базы данных политик маршрутизации и нескольких таблиц маршрутизации»](http://linux-ip.net/html/adv-rpdb.html "10.3.  Использование базы данных политик маршрутизации и нескольких таблиц маршрутизации") .

### Г.2.2. Отображение кеша маршрутизации с **ip route show cache**

Кэш маршрутизации используется ядром в качестве таблицы поиска, аналогичной карточке быстрого справочника. Ядру быстрее обратиться к кешу (внутренне реализованному в виде хеш-таблицы) для недавно использованного маршрута, чем снова искать адрес назначения. Маршруты, существующие в кэше маршрутов, периодически устаревают.

Кэш маршрутизации можно отобразить во всей красе с помощью **ip route show cache** , который обеспечивает подробное представление последних IP-адресов пунктов назначения и основных характеристик этих пунктов назначения. На маршрутизаторах, маскирующихся под бокс и брандмауэры, кэш маршрутизации может стать очень большим. Вместо просмотра всего кеша маршрутизации даже на рабочей станции мы выберем конкретное место назначения из кеша маршрутизации для проверки.

**Пример Г.14. Отображение кеша маршрутизации с ip route show cache**

```
[root@tristan]# 
```

  

ИСПРАВИТЬ МЕНЯ! Я не знаю, как объяснить rtt, rttvar и cwnd, даже прочитав комментарии Алексея в документации iproute2! Мало того, я не уверен, почему есть две записи!

Выходные данные в [примере D.14, «Отображение кэша маршрутизации с помощью кэша показа маршрута ip »](http://linux-ip.net/html/tools-ip-route.html#ex-tools-ip-route-show-cache "Пример Г.14.  Отображение кеша маршрутизации с ip route show cache") , резюмируют доступность пункта назначения 192.168.100.17 из 192.168.99.35. Первая строка каждой записи предоставляет важную для нас информацию: IP-адрес назначения, IP-адрес источника, шлюз, через который доступен пункт назначения, и интерфейс, через который маршрутизировались пакеты. Вместе эти данные идентифицируют запись маршрута в кэше.

Характеристики этого маршрута приведены во второй строке каждой записи. Для маршрута между `tristan`и `isolde`мы видим, что обнаружение Path MTU определило 1500 байт как максимальный размер пакета из конца в конец. Максимальный размер сегмента (MSS) данных составляет 1460 байт. Хотя обычно это представляет не какой-либо, а самый случайный интерес, это может быть полезной диагностической информацией.

Если вы ярый поклонник статистики и не можете получить достаточно информации о маршрутизации на вашем компьютере, вы всегда можете переключиться `-s`.

**Пример Г.15. Отображение статистики из кэша маршрутизации с помощью ip -s route show cache**

```
[root@tristan]# 
```

  

С этим выводом вы получите немного больше информации о маршрутах. Наиболее интересными данными обычно является поле «используется», которое указывает количество обращений к этому маршруту в кэше маршрутизации. Это может дать вам очень хорошее представление о том, сколько раз использовался конкретный маршрут. Поле age используется ядром, чтобы решить, когда истечет срок действия записи в кэше. Возраст сбрасывается каждый раз при доступе к маршруту [[51]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855328128) .

Таким образом, вы можете использовать кеш маршрутизации, чтобы узнать многое об удаленных IP-адресах и некоторых характеристиках сетевого пути к этим адресатам.

### Д.2.3. Использование **ip route add** для заполнения таблицы маршрутизации

**ip route add** используется для заполнения таблицы маршрутизации. Хотя вы можете использовать [**route add,**](http://linux-ip.net/html/tools-route.html#tools-route-add "Д.1.4.  Создание статического маршрута с добавлением маршрута") чтобы сделать то же самое, **ip route add** предлагает большое количество опций, которые невозможны с почтенной **командой route** . После того, как мы рассмотрели несколько простых примеров, мы обсудим более сложные маршруты с помощью **ip route** .

В [разделе D.1 « **маршрут** »](http://linux-ip.net/html/tools-route.html "Д.1.  маршрут") мы использовали два классических примера добавления сетевого маршрута (в сеть нашего поставщика услуг из ) и маршрута к хосту. Давайте посмотрим на разницу в синтаксисе команды **ip route** .

**Пример Г.16. Добавление статического маршрута в сеть с помощью route add , ср. [Пример D.4, «Добавление статического маршрута в добавление сетевого маршрута »](http://linux-ip.net/html/tools-route.html#ex-tools-route-add-net "Пример Г.4.  Добавление статического маршрута к сетевому маршруту")**

```
[root@masq-gw]# 
```

  

Это один из самых простых примеров синтаксиса ip **route** . Как вы помните, вы можете добавить маршрут к сети назначения только через уже доступный шлюз. В этом случае `masq-gw`уже известен маршрут до 192.168.100.1 ( `service-router`). Теперь любые пакеты, привязанные к 10.38.0.0/16, будут пересылаться на 192.168.100.1.

Другие интересные примеры этой команды связаны с использованием `prohibit`и `from`. Использование `prohibit`заставит маршрутизатор сообщить, что запрошенный пункт назначения недоступен. Если вы знаете сетевой блок, на котором размещена служба, в которой вы не заинтересованы, чтобы разрешить доступ вашим пользователям, это эффективный способ заблокировать попытки исходящего подключения.

Давайте посмотрим на пример вывода [**tcpdump**](http://linux-ip.net/html/tools-tcpdump.html "Г.5.  tcpdump") , который показывает `prohibit`маршрут в действии.

**Пример Г.17. Добавление `prohibit`маршрута с помощью route add**

```
[root@masq-gw]# 
```

  

Сравните ICMP-пакет, возвращенный отправителю в этом случае, с [ICMP-пакетом, возвращенным,](http://linux-ip.net/html/pf-host.html#ex-pf-iptables-reject "Пример 7.1.  Блокировка адресата и использование цели REJECT, ср.  Пример D.17, «Добавление запрещенного маршрута с помощью route add»") если вы использовали **iptables** и `REJECT` цель [[52]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855290832) . Хотя конечный результат идентичен (пользователь не может добраться до нужного адресата), пользователь получает два разных сообщения об ошибке. С **iptables** `REJECT` пользователь видит `Connection refused`, где пользователь видит `No route to host`с использованием `prohibit`. Это всего лишь два варианта управления исходящим доступом из вашей сети.

Предположим, вы не хотите блокировать доступ к этому конкретному хосту для всех ваших пользователей, и эта `from`опция придет вам на помощь.

**Пример Г.18. Использование `from`в команде маршрутизации с добавлением маршрута**

```
[root@masq-gw]# 
```

  

Теперь вы эффективно заблокировали исходный IP-адрес 192.168.99.35 от доступа к 209.10.26.51. Любые пакеты, соответствующие этим адресам источника и назначения, будут соответствовать этому маршруту. В этом случае `masq-gw`будет сгенерировано сообщение об ошибке ICMP, указывающее, что пункт назначения недоступен с административной точки зрения.

Если вы все еще читаете здесь, вы можете видеть, что вариантов определения конкретных маршрутов много и они многогранны. Опция `src`предоставляет подсказку ядру для выбора исходного адреса. Когда вы работаете с несколькими таблицами маршрутизации и разными классами трафика, вы можете облегчить свою административную нагрузку, разместив несколько разных IP-адресов на своем компьютере с Linux и задав исходный адрес по-разному, в зависимости от типа трафика.

В приведенном ниже примере предположим, что наш маскирующий хост также запускает преобразователь DNS для внутренней сети, и мы выбрали все исходящие пакеты DNS для маршрутизации в соответствии с таблицей 7 [53 []](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855276096) . Теперь любой пакет, исходящий из этого ящика (или замаскированный через эту таблицу), будет иметь исходный IP-адрес, равный 205.254.211.198.

**Пример Г.19. Использование `src`в команде маршрутизации с добавлением маршрута**

```
[root@masq-gw]# 
```

  

ИСПРАВИТЬ МЕНЯ!! Мне пока не о чем сказать `nexthop`, потому что я никогда не использовал его, это касается `equalize`и `onlink`также. Если у кого-то есть несколько примеров, которые он/она хотел бы внести, я бы хотел услышать.

Существуют и другие варианты **добавления ip route** , описанные в подробной документации Алексея **по iproute2** . Для дальнейших исследований я предложил приобрести и прочитать это руководство.

### Д.2.4. Добавление маршрута по умолчанию с помощью **ip route add default**

Естественно, одним из самых важных маршрутов на машине является маршрут по умолчанию. Добавление маршрута по умолчанию — одна из самых простых операций с **ip route** .

Нам нужна ровно одна часть информации, чтобы установить маршрут по умолчанию на машине. Это IP-адрес шлюза. Синтаксис команды чрезвычайно прост и, если не считать использования `via`вместо `gw`, это почти та же команда, что и эквивалентный **маршрут -n** .

**Пример Г.20. Установка маршрута по умолчанию с помощью ip route add default**

```
[root@tristan]# 
```

  

### Д.2.5. Настройка NAT с **ip route add nat**

Обязательно ознакомьтесь с [главой 5, _Трансляция сетевых адресов (NAT)_](http://linux-ip.net/html/ch-nat.html "Глава 5. Преобразование сетевых адресов (NAT)") для полного рассмотрения вопросов, связанных с трансляцией сетевых адресов (NAT). Если вы здесь, чтобы узнать немного больше о том, как настроить NAT в вашей сети, то вы должны знать, что ip **route add nat** — это только половина решения. Вы должны понимать, что выполнение NAT с помощью **iproute2** включает один компонент для перезаписи входящего пакета ( **ip route add nat** ) и другую команду для перезаписи исходящего пакета ( [**ip rule add nat**](http://linux-ip.net/html/tools-ip-rule.html#tools-ip-rule-add-nat "Г.3.4.  ip правило добавить nat")). Если вы установите только половину системы, ваш NAT будет работать только наполовину или не будет работать вообще, в зависимости от того, как вы определяете «работу».

Алексей четко документирует в приложении к руководству **iproute2** , что NAT, предоставляемый пакетом **iproute2** , не имеет состояния. Это явно отличается от NAT с сетевым фильтром. Обратитесь к [Разделу 5.5, «Назначение NAT с netfilter (DNAT)»](http://linux-ip.net/html/nat-dnat.html "5.5.  NAT назначения с сетевым фильтром (DNAT)") и [Разделу 8.3, «Отслеживание подключения Netfilter»,](http://linux-ip.net/html/state-conntrack.html "8.3.  Отслеживание соединений Netfilter") чтобы лучше ознакомиться с отслеживанием подключения и поддержкой трансляции сетевых адресов, доступной в netfilter.

Команда **ip route add nat** используется для перезаписи адреса назначения пакета с одного IP-адреса или диапазона на другой IP-адрес или диапазон. Инструменты **iproute2** могут работать только со всем IP-пакетом. **Непосредственно в пакете iproute2** не предусмотрена поддержка условной перезаписи на основе порта назначения дейтаграммы UDP или сегмента TCP. Это весь пакет, каждый пакет и ничего, кроме пакета [[54]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855243504) .

**Пример Г.21. Создание маршрута NAT для одного IP с ip route add nat**

```
[root@masq-gw]# 
```

  

Запись маршрута, которую мы только что сделали, указывает ядру переписать любой входящий пакет, связанный с 205.254.211.17, на 192.168.100.17. Фактическая перезапись пакета происходит на этапе маршрутизации пакетов, проходящих через ядро. Это важная деталь, более подробно освещенная в [Разделе 5.4, «NAT без сохранения состояния и фильтрация пакетов»](http://linux-ip.net/html/nat-stateless-pf-interaction.html "5.4.  NAT без сохранения состояния и фильтрация пакетов") .

**iproute2** может поддерживать преобразование сетевых адресов не только для отдельных IP-адресов, но и для целых сетевых диапазонов. Синтаксис по существу аналогичен приведенному выше синтаксису, но вместо одного IP-адреса используется сетевой адрес CIDR.

**Пример Г.22. Создание маршрута NAT для всей сети с помощью ip route add nat**

```
[root@masq-gw]# 
```

  

В этом примере мы добавляем маршрут для всей сети. Любые IP-пакеты, поступающие к нам и предназначенные для любого адреса между 205.254.211.32 и 205.254.211.39, будут перезаписаны на соответствующий адрес в диапазоне от 192.168.100.32 до 192.168.100.39. Это сокращенный способ указать несколько переводов с помощью нотации CIDR.

Опять же, это только половина истории NAT с **iproute2** . Обязательно прочитайте раздел ниже для получения информации об использовании [**правила ip add nat**](http://linux-ip.net/html/tools-ip-rule.html#tools-ip-rule-add-nat "Г.3.4.  ip правило добавить nat") в дополнение к [Главе 5, _Трансляция сетевых адресов (NAT)_](http://linux-ip.net/html/ch-nat.html "Глава 5. Преобразование сетевых адресов (NAT)") , которая предоставит более полную документацию по поддержке NAT в Linux. Не забудьте использовать [**ip route flush cache**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-flush-cache "Д.2.10.  сброс кэша IP-маршрута") после добавления NAT-маршрутов и соответствующих NAT-правил [[55]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855220208) .

### Д.2.6. Удаление маршрутов с помощью **ip route del**

Команда **ip route del** имеет точно такой же синтаксис, что и команда [**ip route add**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-add "Д.2.3.  Использование ip route add для заполнения таблицы маршрутизации") , поэтому, если вы знакомы с синтаксисом, это будет несложно.

На самом деле почти тривиально удалить маршруты в командной строке с помощью **ip route del** . Вы можете просто указать маршрут, который хотите удалить, с помощью команды [**ip route show**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show "Д.2.1.  Отображение таблицы маршрутизации с ip route show") и дословно добавить строку вывода к **ip route del** .

**Пример Г.23. Удаление маршрутов с помощью ip route del [[56]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855208128)**

```
[root@masq-gw]# 
```

  

Мы определили сетевой маршрут к 10.38.0.0/16 как маршрут, который мы хотели удалить, и просто добавили описание маршрута к нашей команде **ip route del .**

Эта команда может использоваться для удаления маршрутов, таких как широковещательные маршруты и маршруты к локально размещенным IP-адресам, в дополнение к манипулированию любыми другими таблицами маршрутизации. Это означает, что вы можете вызвать очень странные проблемы на своем компьютере, непреднамеренно удалив маршруты, особенно маршруты к локально размещенным IP-адресам.

### Д.2.7. Изменение существующих маршрутов с **изменением IP-маршрута**

Иногда вам может понадобиться удалить маршрут и заменить его другим. К счастью, это можно сделать атомарно с помощью **изменения маршрута ip** .

Давайте изменим маршрут по умолчанию на тристане с помощью этой команды.

**Пример Г.24. Изменение существующих маршрутов с изменением IP-маршрута**

```
[root@tristan]# 
```

  

Если вы используете команду **ip route change** , вы должны знать, что она не передает информацию об изменении состояния таблицы маршрутизации в кеш маршрутизации, так что это еще одно хорошее место, где можно привыкнуть к использованию [**ip route flush cache**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-flush-cache "Д.2.10.  сброс кэша IP-маршрута") .

Больше нечего сказать об использовании этой команды. Если вы не хотите использовать [**ip route del,**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-del "Д.2.6.  Удаление маршрутов с помощью ip route del") за которым следует [**ip route add,**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-add "Д.2.3.  Использование ip route add для заполнения таблицы маршрутизации") вы можете использовать **ip route change** .

### Д.2.8. Программное получение информации о маршруте с помощью **ip route get**

При настройке таблиц маршрутизации не всегда достаточно вручную искать пункт назначения. Особенно с большими таблицами маршрутизации это может стать довольно скучным и трудоемким занятием. К счастью, **ip route get** элегантно решает проблему. Имитируя запрос для указанного пункта назначения, **ip route get** запускает алгоритм выбора маршрута. Когда это будет завершено, он распечатает результирующий путь к месту назначения. В некотором смысле это почти эквивалентно отправке пакета эхо-запроса ICMP с последующим использованием [**ip route show cache**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show-cache "Г.2.2.  Отображение кеша маршрутизации с ip route show cache") .

**Пример Г.25. Тестирование таблиц маршрутизации с помощью ip route get**

```
[root@tristan]# 
```

  

Для случайного использования **ip route get** — бесценный инструмент. Очевидным побочным эффектом использования **ip route является** увеличение количества использований каждой затронутой записи в кэше маршрутизации. Хотя это не проблема, это изменит количество пакетов, которые использовали этот конкретный маршрут. Если вы используете **ip** для подсчета исходящих пакетов (люди делали это!), вы должны быть осторожны с этой командой.

### Д.2.9. Очистка таблиц маршрутизации с помощью **ip route flush**

Опция `flush`при использовании с **ip route** очищает таблицу маршрутизации или удаляет маршрут для определенного пункта назначения. В [примере D.26, «Удаление определенного маршрута и очистка таблицы маршрутизации с помощью ip route flush »](http://linux-ip.net/html/tools-ip-route.html#ex-tools-ip-route-flush "Пример Г.26.  Удаление определенного маршрута и очистка таблицы маршрутизации с помощью сброса маршрута ip") , мы сначала удалим маршрут для сети назначения с помощью **ip route flush** , а затем удалим все маршруты в таблице маршрутизации. главная таблица маршрутизации одной командой.

Если вы не хотите удалять маршруты вручную, вы можете быстро очистить все маршруты в таблице, указав идентификатор таблицы в команде **ip route flush** .

**Пример Г.26. Удаление определенного маршрута и очистка таблицы маршрутизации с помощью сброса маршрута ip**

```
[root@masq-gw]# 
```

  

Обратите внимание, что вы должны проявлять осторожность при использовании **таблицы сброса маршрутов ip,** потому что вы можете легко уничтожить свой собственный маршрут к машине, указав основную таблицу маршрутизации или таблицу маршрутизации, которая используется для отправки пакетов на вашу рабочую станцию. Естественно, это не проблема, если вы подключены к машине через последовательный порт, модем, консоль или другое внешнее соединение.

### Д.2.10. **сброс кэша IP-маршрута**

Выше, в [разделе D.2.2, «Отображение кеша маршрутизации с помощью **ip route show cache** »](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show-cache "Г.2.2.  Отображение кеша маршрутизации с ip route show cache") , мы рассмотрели содержимое кеша маршрутизации, хеш-таблицы в ядре, которая содержит недавно использованные маршруты. Цитируя Джона С. Денкера, вы не должны забывать использовать **ip route flush cache** после того, как вы изменили таблицы маршрутизации; «иначе изменения вступят в силу только после какой-то безумно невоспроизводимой задержки». [[57]](http://linux-ip.net/html/tools-ip-route.html#ftn.idm140337855142768)

Поскольку ядро ​​обращается к кешу маршрутизации перед получением нового маршрута из таблиц маршрутизации, **ip route flush cache** очищает кеш от любых данных. Теперь, когда ядро ​​обращается к кешу маршрутизации, чтобы найти наилучший маршрут к пункту назначения, оно обнаруживает, что кеш пуст. Затем он просматривает базу данных политик маршрутизации и таблицы маршрутизации. Когда ядро ​​находит маршрут, оно вводит только что выбранный пункт назначения в кеш маршрутизации.

**Пример Г.27. Очистка кеша маршрутизации с помощью ip route flush cache**

```
[root@tristan]# 
```

  

При внесении изменений в маршрутизацию в Linux-боксе вы можете сэкономить время на устранение неполадок (и путаницу), выработав привычку завершать свои команды маршрутизации с помощью **ip route flush cache** .

### Д.2.11. Резюме использования **ip route**

С этим обзором использования утилиты **ip route** вы должны быть готовы шагнуть на более продвинутую территорию, чтобы использовать несколько таблиц маршрутизации, использовать преимущества специальных типов маршрутов, использовать преобразование сетевых адресов и собирать подробную статистику об использовании вашей сети. таблицы маршрутизации.

  

---

[[49]](http://linux-ip.net/html/tools-ip-route.html#idm140337855371744) Пока я намерен специально пренебречь обсуждением мостовых и широковещательных адресов. Предположим простой Ethernet, где вся IP-сеть находится на одном концентраторе или коммутаторе.

[[50]](http://linux-ip.net/html/tools-ip-route.html#idm140337855369408) Когда пользователь инициирует подключение к локальному хосту (скажем, к локальному хосту: 25, где прослушивается частный SMTP-сервер), подключение может, конечно, исходить с IP-адреса, назначенного любому из интерфейсов Ethernet. Однако имеет смысл установить исходный IP-адрес 127.0.0.1, поскольку соединение фактически инициируется с локального компьютера. Некоторые службы, работающие на локальном компьютере, полагаются на петлевой интерфейс и ограничивают входящие соединения исходными адресами 127.0.0.1. Честно говоря, я нахожу это вполне разумным для сервисов, которые не предназначены для публичного использования.

[[51]](http://linux-ip.net/html/tools-ip-route.html#idm140337855328128) Будьте осторожны с использованием [**ip route get**](http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-get "Д.2.8.  Программное получение информации о маршруте с помощью ip route get") и **ip route show cache,** поскольку **ip route get** неявно вызывает поиск маршрута, тем самым увеличивая используемый счетчик на маршруте и сбрасывая возраст. Это изменит статистику, сообщаемую **ip -s route show cache** .

[[52]](http://linux-ip.net/html/tools-ip-route.html#idm140337855290832) Обратите внимание, что в примере с перекрестными ссылками я использовал **iptables** . Такого же поведения следует ожидать и с **ipchains** . (У кого-нибудь есть доказательства?)

[[53]](http://linux-ip.net/html/tools-ip-route.html#idm140337855276096) Если вам интересно, как осуществляется подобная магия, вам следует прочитать [Раздел 10.3.2, «Использование fwmark для маршрутизации на основе политик»](http://linux-ip.net/html/adv-rpdb.html#adv-routing-fwmark "10.3.2.  Использование fwmark для маршрутизации политик") .

[[54]](http://linux-ip.net/html/tools-ip-route.html#idm140337855243504) Это не должно приводить вас к мысли, что это невозможно сделать. Это все-таки линукс! Путем маршрутизации через fwmark и использования `--mark`опции **ipchains** или цели и`--set-mark`опции MARK в **iptables** вы можете выполнять условную маршрутизацию на основе характеристик и содержимого пакета.

[[55]](http://linux-ip.net/html/tools-ip-route.html#idm140337855220208) Вы всегда можете использовать мой [сценарий инициализации SysV](http://linux-ip.net/html/scripts-nat.html#ex-sc-nat "Пример 11.3.  Сценарий инициализации статического NAT SysV") и [файл конфигурации](http://linux-ip.net/html/scripts-nat.html#ex-sc-static-nat "Пример 11.4.  Статический файл конфигурации NAT") вместо того, чтобы вводить свои собственные команды, однако всегда важно понимать, какой инструмент вы используете.

[[56]](http://linux-ip.net/html/tools-ip-route.html#idm140337855208128) Обратите внимание, что это та же самая таблица маршрутизации, которая показана в [Примере D.2, «Просмотр сложной таблицы маршрутизации с помощью route »](http://linux-ip.net/html/tools-route.html#ex-tools-route-show-complex "Пример Г.2.  Просмотр сложной таблицы маршрутизации с маршрутом") , который отображает вывод от **route -n** на `masq-gw`.

[[57]](http://linux-ip.net/html/tools-ip-route.html#idm140337855142768) См. это замечание в его [документации](http://www.quintillion.com/moat/ipsec+routing/iproute2.html) об обходном пути с FreeS/WAN и iproute2, чтобы приблизиться к поведению SPD, более похожему на RFC, для туннеля IPSec в Linux.

---

[Пред.](http://linux-ip.net/html/tools-route.html) 

[Вверх](http://linux-ip.net/html/tools-ip-routing.html)

 [Следующий](http://linux-ip.net/html/tools-ip-rule.html)

Д.1. **маршрут** 

[Дом](http://linux-ip.net/html/index.html)

 Д.3. **IP-правило**
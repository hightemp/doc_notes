17 апреля 2023 года «Яндекс» [отключает бесплатную почту для бизнеса](https://vc.ru/claim/557828-yandeks-pochta-halyava-konchilas) и предлагает платить [от 249 до 1399₽](https://360.yandex.ru/business/tariff/) за юзера в месяц. Если не оплатить услуги, все аккаунты [«Яндекс 360»](https://360.yandex.ru/) будут принудительно переведены в режим чтения, то есть читать письма будет можно, а отвечать на них — нет.  
  
Переход на платные тарифы обязателен для всех доменов (включая семейные аккаунты) с количеством пользователей больше трёх.  
  
Конечно, легче всего согласиться на условия и оплатить требуемую сумму. На это и рассчитывает провайдер, что 99% клиентов молча заплатят деньги, ведь у них нет другого выхода… Но на самом деле выход есть.  
  
Если в двух словах, можно взять недорогой VPS, поставить туда один из свободных почтовых серверов и сэкономить пару тысяч рублей. Или сотен тысяч, смотря сколько у вас сотрудников. Финансовая раскладка под катом.  
  
Рассмотрим плюсы и минусы своего сервера.  
  
Главный плюс — это деньги. Как известно, сэкономленный рубль не отличается от заработанного. То есть сэкономленные на оплате тарифа деньги — чистая прибыль вашей компании, которую можно пустить в оборот, выплатить дивиденды и премии сотрудникам.  
  
Давайте посчитаем, сколько денег мы получим при переходе с «Яндекса» на свой почтовый сервер. «Яндекс» предлагает для бизнеса три тарифа: базовый, оптимальный и расширенный. Они отличаются количеством места на Диске для каждого сотрудника (от 100 ГБ до 3 ТБ), количеством писем в рассылках (от 1500 до 100 000), наличием/отсутствием трансляций, функции единого входа (SSO), защищённого архива рабочих писем и срока действия публичных ссылок для скачивания.  
  
Тарифы «Яндекса» для бизнеса, а также свой VPS для разного количества пользователей, цена за год:  
  

Количество сотрудников

Тариф «Яндекса»

Свой VPS (Москва)

Базовый

Оптимальный

Расширенный

_10_

29 880₽

56 280₽

167 880₽

18 300₽

_50_

149 400₽

281 400₽

839 400₽

44 712₽

_300_

337 680₽

1 688 400₽

5 036 400₽

77 436₽

*Примечание. Для своего сервера в [конфигураторе VPS](https://ruvds.com/ru-rub#order) установлены следующие характеристики:  
  

-   10 пользователей — Intel Xeon, 2,2 ГГц (1 CPU), 4 ГБ RAM, HDD 100 ГБ;  
    
-   50 пользователей — Intel Xeon, 2,2 ГГц (3 CPU), 8 ГБ RAM, HDD 300 ГБ;  
    
-   300 пользователей — Intel Xeon, 3,4 ГГц (6 CPU), 8 ГБ RAM, HDD 600 ГБ.

  
В расчёте годовой цены указан только основной диск, без учёта подключения дополнительных HDD (500₽ за терабайт в месяц)  
  
Во сколько конкретно обойдётся виртуалка на Linux с почтовым сервером, можно посмотреть в [конфигураторе](https://ruvds.com/ru-rub#order).  
  
![](https://habrastorage.org/r/w1560/webt/sx/jj/ve/sxjjveau64stc4deag7sakhayt8.png)  
  
На первый взгляд кажется, что на «Яндексе» более дешёвое дисковое пространство, чем на своём хостинге. У них можно взять «Расширенный» пакет с 3 ТБ для каждого сотрудника за 1399₽ в месяц, а на своём хостинге каждый дополнительный терабайт обойдётся ежемесячно в 500₽ (которые нужно прибавить к сумме в таблице выше). Но в реальности на своём сервере дополнительное место докупают _по мере необходимости_, а «Яндекс» требует оплатить всё и сразу. Причём минимум 100 ГБ на каждого пользователя. Независимо от того, используете вы это место или нет. Поэтому в базовой таблице мы указали только изначальную конфигурацию сервера. А если почтовый архив разрастётся, к нему постепенно докупают терабайты раз в несколько лет. Бэкапы можно делать локально (и хранить бесплатно).  
  
Аналогичные расчёты мы уже приводили в статье [«Как использовать GitLab в условиях санкций?»](https://habr.com/ru/companies/ruvds/articles/715010/) про переезд на собственный сервер Gitlab. Тут наблюдается схожий эффект — с определённого количества пользователей переход на свой сервер становится выгодным и почти неизбежным.  
  
Экономия денег — основное преимущество собственного почтового сервера. А вот главные недостатки:  
  

1.  Сложность в установке и настройке.  
    
2.  Большие усилия на поддержку. Имеется в виду не техническая поддержка, которая сводится к периодическому `apt-get upgrade` и занимает [10–15 минут в месяц](https://schumacher.sh/2021/05/10/running-a-private-mail-server-for-six-years-easy-peasy.html), а усилия по защите репутации. Об этом ниже.

  

## ▍ 1. Установка

  
По первому пункту можно рекомендовать [подробную инструкцию](https://flurdy.com/docs/postfix/) по установке и настройке продвинутого почтового сервера под Linux. Пакет установки включает Ubuntu + Postfix + Courier/Dovecot IMAP + MySQL + Amavisd-new + SpamAssassin + ClamAV + SASL + TLS + Roundcube + Postgrey. В итоге мы получаем полноценный сервер с неограниченным количеством пользователей и доменов, доступом по IMAP, фильтром спама, антивирусом, безопасной аутентификацией, шифрованием трафика и веб-интерфейсом. При этом не платим никакому почтовому провайдеру ни копейки. Всё полностью под своим контролем.  
  
Это набор в максимальной конфигурации по типу «всё включено». В минимальном варианте для работы почтового сервера достаточно двух пакетов: Postfix (SMTP) и Dovecot (IMAP), плюс записи в DNS. Это всё. Совсем необязательно устанавливать СУБД для архива, антивирусы, антиспам и прочие модули. На самом деле можно начать с минимума, а потом добавлять эти модули по мере необходимости.  
  
Пошаговая инструкция начинается с установки Ubuntu 20.04, но по факту можно поставить другой дистрибутив, и дальнейшие инструкции не теряют своей актуальности. И ещё один момент: в инструкции инстансы поднимаются на Amazon AWS, но исключительно в демонстрационных целях. Всю установку можно провести на локальном ПК у себя дома, в офисе или на VPS у хостера.  
  
![](https://habrastorage.org/r/w1560/webt/24/no/cu/24nocuxc4vl3rreiq_lxqwlor6m.png)  
_Схема почтового сервера на FreeBSD с использованием Postfix, Dovecot, Rspamd и LDAP, [источник](https://www.c0ffee.net/blog/mail-server-guide)_  
  

## ▍ 2. Защита репутации

  
По части защиты репутации проблема в том, что крупные почтовые провайдеры типа Gmail, Hotmail и той же «Яндекс.Почты» [постоянно пытаются отфильтровать наши письма как спам](https://research.google.com/pubs/archive/45.pdf). То есть письма с нашего сервера просто не доходят до адресатов. Вот [основные рекомендации](https://bridge.grumpy-troll.org/2020/07/small-mailserver-bcp/), как этого избежать:  
  

-   SPF и DKIM с правильными настройками;  
    
-   запись DMARC;  
    
-   ограничить количество отправляемых сообщений;  
    
-   использовать специализированные сервисы, такие как [Postmaster Tools](https://www.gmail.com/postmaster/) от Gmail, чтобы отслеживать репутацию домена и оптимизировать настройки;  
    
-   кроме репутации домена, следить за репутацией IP-адреса. Периодическая проверка чёрных списков [на сайте Spamhaus](https://check.spamhaus.org/) и в специальных сервисах типа SenderScore.org;  
      
    ![](https://habrastorage.org/r/w1560/webt/o6/dw/is/o6dwisipshpybdaebpsgvyf3jj4.png)  
      
    
-   аккуратный выбор записей DNS и записи MX;  
    
-   сертификат Let’s Encrypt;  
    
-   использовать [fail2ban](https://www.fail2ban.org/) и сканировать серверные логи для проверки, что через ваш сервер не пересылается спам;  
    
-   очень важно [выбрать правильного хостера](https://www.spamhaus.org/news/article/719/a-survival-guide-for-the-small-mail-server).

  
Проверка своего почтового домена на сайте [Mailtester](https://www.mail-tester.com/):  
  
![](https://habrastorage.org/r/w1560/webt/r5/at/f8/r5atf8ujk4ousebmhm-58uillwu.jpeg)  
  

## ▍ Выбор почтового сервера

  
В [упомянутой выше](https://habr.com/ru/companies/ruvds/articles/729742/#1) инструкции по установке почтового сервера используется самый простой опенсорсный софт:  
  

-   **Почтовый сервер**: [Postfix](http://www.postfix.org/).  
    
-   **Pop/IMAP**: [Courier IMAP](https://www.courier-mta.org/imap/) или [Dovecot](https://www.dovecot.org/).  
    
-   **СУБД**: MySQL.

  
Но в реальности существует [огромный выбор почтовых серверов](https://en.wikipedia.org/wiki/List_of_mail_server_software), которые можно использовать. Некоторые из них хорошо известны, а другие появились совсем недавно:  
  

-   [Postfix](http://www.postfix.org/) (SMTP),  
    
-   [Dovecot](https://www.dovecot.org/) (IMAP),  
    
-   [OpenSMTPD](https://www.opensmtpd.org/),  
    
-   [Sendmail](https://www.proofpoint.com/us/products/email-protection/open-source-email-solution),  
    
-   [Sovereign](https://github.com/al3x/sovereign) для Ansible,  
    
-   [Axigen](https://www.axigen.com/),  
    
-   [Apache James](https://james.apache.org/),  
    
-   [Citadel](https://citadel.org/),  
    
-   [Courier Mail Server](https://www.courier-mta.org/),  
    
-   [Exim](https://www.exim.org/),  
    
-   [Kolab](http://kolab.org/).

  
[Сравнение](https://en.wikipedia.org/wiki/Comparison_of_mail_servers) почтовых серверов по функциональности:  
  
![](https://habrastorage.org/r/w1560/webt/ki/4a/ho/ki4ahoiwctxpqvcwflfza-cxnuw.png)  
  
Другие интересные разработки:  
  

-   [Salmon](https://salmon-mail.readthedocs.io/en/latest/) — почтовый сервер на чистом Python.  
    
-   [Maddy Mail Server](https://maddy.email/) — один демон, который заменяет собой Postfix, Dovecot, OpenDKIM, OpenSPF и OpenDMARC.  
    
-   [Poste.io](https://poste.io/) — SMTP + IMAP + POP3 + антиспам + антивирус + веб-админка + веб-почта в одном пакете. Ставится на сервере за пять минут.  
      
    ![](https://habrastorage.org/r/w1560/webt/zu/d6/8f/zud68fnxd0txinmepgdjf3hpulc.png)  
      
    **
    
    **Скриншоты Poste.io**
    
    **  
    
-   [Mox](https://github.com/mjl-/mox) — ещё один простой в установке пакет «всё в одном» (SMTP, IMAP, SPF/DKIM/DMARC, фильтрация спама).

  
Нужно добавить, что поддержка почтового сервера — не такая критическая задача, как мониторинг аптайма веб-сервера. Даже если ваш сервер уйдёт в офлайн на пару дней (или IP занесут в чёрный список), входящая и исходящая почта всё равно будет отправлена и получена после его возвращения в строй (или выхода из блеклиста). Электронная почта — крайне надёжная технология. Это самый успешный децентрализованный протокол в истории интернета. Тут сложно напортачить или что-то испортить, она работает _в любых условиях_.  
  
**Примечание 1.** Некоторые пользователи склоняются к мнению, что после 17 апреля можно перейти на почту Mail.ru, которая пока остаётся бесплатной. Но нужно понимать, что те причины, которые вынудили «Яндекс» ввести платные тарифы (удорожание инфраструктуры и дефицит серверов из-за санкций), действуют для Mail.ru тоже, так что такая миграция — временное решение. В конце концов придётся решать проблему кардинально и переходить на свой VPS, если вы хотите организовать почтовый сервер надёжно, дёшево и полностью под своим контролем, без [перенаправления](https://www.cloudflare.com/products/email-routing/) [почты](https://forwardemail.net/en) (кстати, это тоже выход — почта со всех адресов вашего домена перенаправляется в любой указанный ящик).  
  
**Примечание 2.** Если хотите сохранить почтовый домен для семьи, то Gmail принял решение [оставить такие группы бесплатными до шести человек](https://myaccount.google.com/family/create) (у «Яндекса» до трёх).
(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{335:function(t,e,r){"use strict";r.r(e);var i=r(14),a=Object(i.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("https://wiki.dieg.info/iproute")]),t._v(" "),e("h1",{attrs:{id:"использование-и-примеры-маршрутизации-linux"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#использование-и-примеры-маршрутизации-linux"}},[t._v("#")]),t._v(" Использование и примеры маршрутизации Linux")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wiki.dieg.info/_media/iproute2.png",alt:""}})]),t._v(" "),e("p",[t._v("Одной из главнейших задач "),e("a",{attrs:{href:"https://wiki.dieg.info/osi?&#setevoj_uroven",title:"osi",target:"_blank",rel:"noopener noreferrer"}},[t._v("сетевого уровня"),e("OutboundLink")],1),t._v(" модели OSI является маршрутизация. Устройства, которые связывают подсети между собой в единую составную сеть, называются маршрутизаторами. Внутри сети сегменты не разделяются маршрутизаторами, иначе это была бы не одна сеть, а несколько сетей. Маршрутизатор соединят несколько сетей в интерсеть (internetwork или internet).")]),t._v(" "),e("p",[t._v("Данные, которые поступают на сетевой уровень и которые необходимо передать через составную сеть, снабжаются заголовком сетевого уровня. Данные вместе с заголовком образуют пакет. Заголовок пакета сетевого уровня имеет унифицированный формат, не зависящий от форматов кадров канального уровня тех сетей, которые могут входить в объединенную сеть, и несет наряду с другой служебной информацией данные о номере сети, которой предназначается этот пакет. Явная нумерация сетей позволяет протоколам сетевого уровня составлять точную карту межсетевых связей и выбирать рациональные маршруты при любой их топологии, в том числе альтернативные маршруты, если они имеются, что никак не умеют делать мосты и коммутаторы.")]),t._v(" "),e("p",[t._v("Сетевой уровень определяет маршрут пути следования пакета и перемещает его между подсетями. При передаче пакета из одной подсети в другую пакет сетевого уровня, инкапсулированный в прибывший канальный кадр первой подсети, освобождается от заголовков этого кадра и окружается заголовками кадра канального уровня следующей подсети. Информацией, на основе которой делается эта замена, являются служебные поля пакета сетевого уровня.")]),t._v(" "),e("p",[e("strong",[t._v("Резюмируем")]),t._v(".")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("построение неоднородных сетей реализуют с помощью сетевого уровня.")])]),t._v(" "),e("li",[e("p",[t._v('сетевой уровень использует собственную адресацию, которая обеспечивает каждому узлу подсети составной сети свой универсальный сетевой адрес, который состоит из номера сети и номера узла. Благодаря такой системе адресации сетевой уровень может пересылать информации к узлу получателю "не обращая внимания" на внутреннюю структуру подсетей, с другой стороны для непосредственного продвижения пакетов к адресату, он использует технологию передачи данных конкретной подсети, через которую следуют эти пакеты.')])]),t._v(" "),e("li",[e("p",[t._v("поиск наилучшего пути следования пакетов в сети - маршрутизация - это основная задача сетевого уровня.")])]),t._v(" "),e("li",[e("p",[t._v("сети соединяются между собой с помощью маршрутизаторов. Маршрутизаторы занимаются сбором информации о топологии межсетевых соединений, и на ее основании пересылают данные в пункт назначения.")])])]),t._v(" "),e("p",[e("strong",[t._v("Основная функция маршрутизатора")]),t._v(" - чтение заголовков пакетов сетевых протоколов, которые принимаются и буферизуются по каждому его порту, и принятие решения о дальнейшем маршруте следования того пакета в соответствии с указанным в нем сетевым адресом. Сетевой адрес пакета сетевого протокола включает, как правило, номер сети номер узла.")]),t._v(" "),e("h1",{attrs:{id:"маршрутизация-статическая"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#маршрутизация-статическая"}},[t._v("#")]),t._v(" Маршрутизация статическая")]),t._v(" "),e("p",[e("strong",[t._v("Статическая маршрутизация")]),t._v(" является одним из способов задания маршрута следования пакетов в сетях. При этом протоколы маршрутизации не используются, а необходимая информация заносится системным администратором вручную в соответствующие таблицы маршрутизации. К статическим маршрутам также относится маршрут по умолчанию (default route).")]),t._v(" "),e("p",[t._v("Создание собственных таблиц и правил маршрутизации это и есть "),e("strong",[t._v("Policy-Routing")]),t._v(", он же "),e("strong",[t._v("PBR (Policy-based Routing)")]),t._v(". SBR (Source-based Routing) или Source-Routing в "),e("a",{attrs:{href:"https://wiki.dieg.info/linux",title:"linux",target:"_blank",rel:"noopener noreferrer"}},[t._v("FAQ Linux"),e("OutboundLink")],1),t._v(" является частным случаем "),e("a",{attrs:{href:"https://wiki.dieg.info/iproute?&#policy-routing_marshrutizacija_dlja_dvux_isp",title:"iproute",target:"_blank",rel:"noopener noreferrer"}},[t._v("Policy-Routing"),e("OutboundLink")],1),t._v(", в случае использования условия from в правиле маршрутизации.")]),t._v(" "),e("h1",{attrs:{id:"iproute"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#iproute"}},[t._v("#")]),t._v(" iproute")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Домашняя страница "),e("a",{attrs:{href:"https://wiki.linuxfoundation.org/networking/iproute2",title:"https://wiki.linuxfoundation.org/networking/iproute2",target:"_blank",rel:"noopener noreferrer"}},[t._v("iproute2"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://docstore.mik.ua/manuals/ru/LARTC/index.html",title:"https://docstore.mik.ua/manuals/ru/LARTC/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Перевод Linux Advanced Routing & Traffic Control HOWTO"),e("OutboundLink")],1)])])]),t._v(" "),e("p",[e("strong",[t._v("iproute")]),t._v(" также известна как iproute2.")]),t._v(" "),e("p",[t._v("Пакет iproute состоит из нескольких утилит управления трафиком:")]),t._v(" "),e("ul",[e("li",[e("p",[e("strong",[t._v("ip")]),t._v(" – управление собственно маршрутизацией;")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("tc")]),t._v(" – управление очередями маршрутизации;")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("ss")]),t._v(" — утилита для просмотра текущих соединений и открытых портов, аналог утилиты "),e("a",{attrs:{href:"https://wiki.dieg.info/netstat",title:"netstat",target:"_blank",rel:"noopener noreferrer"}},[t._v("Как пользоваться командой netstat"),e("OutboundLink")],1),t._v(".")])])]),t._v(" "),e("p",[t._v("Доступ ко всем возможностям дает только "),e("strong",[t._v("ip")]),t._v(", использование утилиты route устарело (вы не сможете настроить например политики маршрутизации и не увидите их существование в выводе команды просмотра, если они уже настроены в системе).")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Увидеть IP и "),e("a",{attrs:{href:"https://wiki.dieg.info/mac",title:"mac",target:"_blank",rel:"noopener noreferrer"}},[t._v("MAC -адрес"),e("OutboundLink")],1),t._v(", аналог "),e("a",{attrs:{href:"https://wiki.dieg.info/arp",title:"arp",target:"_blank",rel:"noopener noreferrer"}},[t._v("Работа с ARP протоколом: очистка таблицы"),e("OutboundLink")],1),t._v(" -a")]),t._v(" "),e("h1",{attrs:{id:"ip-neighbour-show"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-neighbour-show"}},[t._v("#")]),t._v(" ip neighbour show")])]),t._v(" "),e("li",[e("p",[t._v("Поиск маршрута для удаленного ip")]),t._v(" "),e("p",[t._v("ip route get 192.168.35.55\n192.168.35.55 via 192.168.35.254 dev tun1  src 10.26.95.254\ncache  ipid 0xf0ea")])]),t._v(" "),e("li",[e("p",[t._v("Для все MAC задает состояние failed, в дальнейшем ядро Ос удалит помеченные так MAC записи из arp таблицы.")]),t._v(" "),e("h1",{attrs:{id:"ip-neigh-flush-all"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-neigh-flush-all"}},[t._v("#")]),t._v(" ip neigh flush all")])]),t._v(" "),e("li",[e("p",[t._v("Вывести запись о маршруте по умолчанию:")]),t._v(" "),e("h1",{attrs:{id:"ip-r-grep-default"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-r-grep-default"}},[t._v("#")]),t._v(" ip r | grep default")])]),t._v(" "),e("li",[e("p",[t._v("Просмотр сетевых карт")]),t._v(" "),e("h1",{attrs:{id:"ip-link-list"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-link-list"}},[t._v("#")]),t._v(" ip link list")])]),t._v(" "),e("li",[e("p",[t._v("Сбросить кеш маршрутизатора")]),t._v(" "),e("h1",{attrs:{id:"ip-route-flush-cache"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-route-flush-cache"}},[t._v("#")]),t._v(" ip route flush cache")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("blackhole")]),t._v(". Добавить «зануленный» маршрут (аналог «ip route … null0» в Cisco). Пакеты в сеть с таким маршрутом будут удалены с причиной «No route to host». Может быть полезно для подавление "),e("a",{attrs:{href:"https://wiki.dieg.info/dos",title:"dos",target:"_blank",rel:"noopener noreferrer"}},[t._v("Что такое DoS (DDoS) -атака"),e("OutboundLink")],1),t._v("-атаки с хоста")]),t._v(" "),e("h1",{attrs:{id:"ip-route-add-blackhole-10-56-50-0-27"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-route-add-blackhole-10-56-50-0-27"}},[t._v("#")]),t._v(" ip route add blackhole 10.56.50.0/27")])]),t._v(" "),e("li",[e("p",[t._v("C помощью команды "),e("strong",[t._v("ip addr add")]),t._v(" можно установить на сетевом интерфейсе как основной IP адрес, так и несколько дополнительных адресов. Удалить IP адрес")]),t._v(" "),e("p",[t._v("ip addr del 10.90.91.254 dev eth4\nили удалить все с интерфейса wlan1\nip addr flush wlan1")])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://wiki.dieg.info/sostojanie_podkljuchenija_setevogo_kabelja",title:"sostojanie_podkljuchenija_setevogo_kabelja",target:"_blank",rel:"noopener noreferrer"}},[t._v("Как узнать состояние подключения сетевого кабеля в Linux"),e("OutboundLink")],1)])])]),t._v(" "),e("h2",{attrs:{id:"таблицы-маршрутизации"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#таблицы-маршрутизации"}},[t._v("#")]),t._v(" Таблицы маршрутизации")]),t._v(" "),e("p",[t._v("Вывести таблицы маршрутизации. Ядро принимает решение о применении той или иной таблицы на основании адреса источника пакета. Эти таблицы применимы для всех пакетов.")]),t._v(" "),e("h1",{attrs:{id:"ip-rule-list"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-rule-list"}},[t._v("#")]),t._v(" ip rule list")]),t._v(" "),e("p",[t._v("0:      from all lookup local\n32766:  from all lookup main\n32767:  from all lookup default")]),t._v(" "),e("p",[t._v("Вывести содержимое таблицы local.")]),t._v(" "),e("h1",{attrs:{id:"ip-route-show-table-local"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-route-show-table-local"}},[t._v("#")]),t._v(" ip route show table local")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Таблица local")]),t._v('. Пакет при выборе пути к месту назначения проверяется правилом с наименьшим приоритетом. Правило 0 отправит поиск маршрута в таблицу "local".')])]),t._v(" "),e("p",[t._v("Таблица local проверяет не адресован ли пакет локальной машине (широковещательный или сетевой адреса интерфейсов). Таблицу local автоматически заполняют команды конфигурации сетевых интерфейсов.")]),t._v(" "),e("ul",[e("li",[e("p",[e("strong",[t._v("Таблица main")]),t._v(" - является основной и именно она используется, если в команде, связанной с маршрутизацией, не указано какую таблицу использовать. При поднятии интерфейсов в неё прописываются маршруты к подсетям интерфейсов, стартовые скрипты также заносят в эту таблицу значение шлюза по-умолчанию. Использование команды route add администратором также может дополнить таблицу маршрутами. В общем случае, таблица main всегда содержит подходящий для пакета маршрут (например шлюз по-умолчанию).")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("Таблица default")]),t._v(" изначально пуста.")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("Модификация таблицы маршрутизации")]),t._v(":")]),t._v(" "),e("p",[t._v("Добавление маршрута через шлюз: ip route add 172.16.10.0/24 via 192.168.1.1\nДобавление маршрута через интерфейс: ip route add 172.16.10.0/24 dev eth0\nМаршрут с метрикой: ip route add 172.16.10.0/24 dev eth0 metric 100")]),t._v(" "),e("p",[t._v("Кроме "),e("strong",[t._v("add")]),t._v(" также поддерживаются и другие действия: "),e("strong",[t._v("del")]),t._v(" — удалить маршрут; "),e("strong",[t._v("replace")]),t._v(" — заменить маршрут другим; "),e("strong",[t._v("change")]),t._v(" — изменить параметры маршрута.")])])]),t._v(" "),e("h1",{attrs:{id:"policy-routing-маршрутизация-для-двух-isp"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#policy-routing-маршрутизация-для-двух-isp"}},[t._v("#")]),t._v(" Policy-Routing. Маршрутизация для двух ISP")]),t._v(" "),e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://habr.com/ru/post/108690/",title:"https://habr.com/ru/post/108690/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Роутинг и policy-routing в Linux при помощи iproute2"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.k-max.name/linux/princip-raboty-routing-policy-database/",title:"https://www.k-max.name/linux/princip-raboty-routing-policy-database/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Принцип работы Routing Policy DataBase"),e("OutboundLink")],1)])])]),t._v(" "),e("p",[e("strong",[t._v("Пример 1. Создание таблицы для маршрутизации пакетов с определенного IP- адреса.")]),t._v(" Локальная сеть 10.26.95.0/24 имеет выход в Интернет с двух разных провайдеров – основной ISP1 (статика) и резервный ISP2 ("),e("a",{attrs:{href:"https://wiki.dieg.info/dhcp",title:"dhcp",target:"_blank",rel:"noopener noreferrer"}},[t._v("Настройка DHCP сервера Linux, FreeBSD"),e("OutboundLink")],1),t._v(").")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("В файле /etc/iproute2/rt_tables для удобства задаются символьные имена таблиц, это не обязательно так как все таблицы имеют цифровые идентификаторы. Например")]),t._v(" "),e("p",[t._v("echo '82 velton' >> /etc/iproute2/rt_tables")])]),t._v(" "),e("li",[e("p",[t._v("Маршрут по умолчанию для таблицы '82 velton'")]),t._v(" "),e("p",[t._v("ip route add default via 82.117.232.1 table 82")])]),t._v(" "),e("li",[e("p",[t._v("Внесем правила маршрутизация для пользователя с IP 10.26.95.5, после чего эта таблица станет доступна в выводе команды ip rule list. Теперь все пользователи шлют пакеты через ISP1, кроме пользователя с IP 10.26.95.251")]),t._v(" "),e("p",[t._v("ip rule add from 10.26.95.251/32 table 82")])]),t._v(" "),e("li",[e("p",[t._v("Очистить кеш маршрутизатора для вступления в силу сделанных изменений")]),t._v(" "),e("p",[t._v("ip route flush cache")])])]),t._v(" "),e("p",[e("strong",[t._v("Пример 2. Создание таблицы для маршрутизации, когда часть сетей (AS) нужно маршрутизировать через резервного провайдер ISP2. Например, это может быть дешевая точка обменом трафика или ресурсы провайдера. "),e("a",{attrs:{href:"https://wiki.dieg.info/whois#whois_-_najti_vse_ips_vashego_provajdera",title:"whois",target:"_blank",rel:"noopener noreferrer"}},[t._v("whois - найти все IPs вашего провайдера"),e("OutboundLink")],1)])]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Создаем как в предыдущем примере маршрут по умолчанию для таблицы '82 velton'")]),t._v(" "),e("p",[t._v("ip route add default via 82.117.232.1 table 82")])]),t._v(" "),e("li",[e("p",[t._v("Прописываем статические маршруты на сети ISP2")]),t._v(" "),e("p",[t._v("ip route add 82.117.224.0/19 via 82.117.234.15\nip route add 85.90.192.0/19 via 82.117.234.15")])]),t._v(" "),e("li",[e("p",[t._v("Добавим rule для всех сетей")]),t._v(" "),e("p",[t._v("ip rule add to 82.117.224.0/19 table 82\nip rule add to 85.90.192.0/19 table 82")])]),t._v(" "),e("li",[e("p",[t._v("Очистить кеш маршрутизатора для вступления в силу сделанных изменений")]),t._v(" "),e("p",[t._v("ip route flush cache")])])])])}),[],!1,null,null,null);e.default=a.exports}}]);
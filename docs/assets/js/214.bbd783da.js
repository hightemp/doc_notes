(window.webpackJsonp=window.webpackJsonp||[]).push([[214],{487:function(e,t,n){"use strict";n.r(t);var a=n(14),s=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("https://habr.com/ru/post/501688/")]),e._v(" "),t("h1",{attrs:{id:"additional-ssr-performance-with-nuxt-fullstack-server-часть-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#additional-ssr-performance-with-nuxt-fullstack-server-часть-2"}},[e._v("#")]),e._v(" Additional SSR performance with Nuxt fullstack server (Часть 2)")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://habr.com/ru/post/501652/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Часть 1: Nuxt as fullstack server: frontend + backend API Server"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("strong",[e._v("Часть 2: Additional SSR performance with Nuxt fullstack server")])])]),e._v(" "),t("p",[e._v("В Части 1 я рассказал как легко организовать "),t("strong",[e._v("API Server")]),e._v(" в "),t("strong",[e._v("Nuxt")]),e._v(". В Части 2 я хочу рассказать какие дополнительные преимущества можно извлечь из "),t("strong",[e._v("Nuxt fullstack server")]),e._v(".")]),e._v(" "),t("h2",{attrs:{id:"часть-2-ускоряем-серверныи-рендериг"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#часть-2-ускоряем-серверныи-рендериг"}},[e._v("#")]),e._v(" Часть 2: ускоряем серверный рендериг!")]),e._v(" "),t("p",[e._v("Давайте подумаем сейчас как работает наш сервер из примера "),t("a",{attrs:{href:"https://codesandbox.io/s/codesandbox-nuxt-3gzhl",target:"_blank",rel:"noopener noreferrer"}},[e._v("codesandbox.io/s/codesandbox-nuxt-3gzhl"),t("OutboundLink")],1)]),e._v(" "),t("ol",[t("li",[t("p",[e._v("Клиент запрашивает главную страницу "),t("a",{attrs:{href:"https://3gzhl.sse.codesandbox.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("3gzhl.sse.codesandbox.io"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("strong",[e._v("Nuxt")]),e._v(" начинает рендерить на сервере страницу "),t("strong",[e._v("/pages/index.vue")])])]),e._v(" "),t("li",[t("p",[e._v("Доходит до")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('  async fetch() {\n    this.users = await this.$api("users", "index");\n  },\n')])])])]),e._v(" "),t("li",[t("p",[e._v("Через "),t("strong",[e._v("axios")]),e._v(" делает "),t("strong",[e._v("http запрос")]),e._v(", по адресу "),t("a",{attrs:{href:"https://3gzhl.sse.codesandbox.io/api/users/index",target:"_blank",rel:"noopener noreferrer"}},[e._v("3gzhl.sse.codesandbox.io/api/users/index"),t("OutboundLink")],1),e._v(" т.е. сам на себя")])]),e._v(" "),t("li",[t("p",[e._v("Устанавливается соединение, создаётся новая сессия на сервере и выделяется память для обработки "),t("strong",[e._v("http запроса")])])]),e._v(" "),t("li",[t("p",[e._v("Принимается входящий запрос по протоколу "),t("strong",[e._v("http")]),e._v(", парсится url, обрабатываются параметры")])]),e._v(" "),t("li",[t("p",[e._v("Отрабатывает "),t("strong",[e._v("серверное middleware")])])]),e._v(" "),t("li",[t("p",[t("strong",[e._v("Nuxt")]),e._v(" запускает наш "),t("strong",[e._v("API Server")])])]),e._v(" "),t("li",[t("p",[e._v("Парсинг параметров в "),t("strong",[e._v("JSON")])])]),e._v(" "),t("li",[t("p",[e._v("Вызывается искомый контроллер "),t("strong",[e._v("users.index()")]),e._v(", который возвращает данные "),t("strong",[e._v("JSON")])])]),e._v(" "),t("li",[t("p",[t("strong",[e._v("JSON")]),e._v(" данные преобразовываются в строку и отправляются по протоколу "),t("strong",[e._v("http")])])]),e._v(" "),t("li",[t("p",[e._v("Данные принимаются библиотекой "),t("strong",[e._v("axios")]),e._v(" и парсятся в "),t("strong",[e._v("JSON")])])]),e._v(" "),t("li",[t("p",[e._v("Сессия API завершается")])])]),e._v(" "),t("p",[e._v("Теперь представим, что у нас на странице находится 20 компонентов которые запрашивают данные через "),t("strong",[e._v("API")]),e._v(", таким образом за один запрос страницы c "),t("strong",[e._v("Nuxt")]),e._v(" сервером будет установлено 20 дополнительных внутренних "),t("strong",[e._v("http")]),e._v(" соединений и пункты 4-13 будут выполнены 20 раз. "),t("strong",[e._v("Nuxt HTTP сервер")]),e._v(" может обрабатывать более 55 тысяч запросов в секунду, однако создавая внутренние HTTP запросы, мы уменьшаем потенциальные ресурсы сервера в десятки раз.")]),e._v(" "),t("p",[e._v("Но ведь когда мы рендерим страницу на сервере, у нас есть прямой доступ до всех контроллеров в папке "),t("strong",[e._v("/api/")])]),e._v(" "),t("p",[e._v("Давайте изменим логику таким образом, чтобы при рендеренге на сервере код контроллера вызывался напрямую, а при вызове из браузера запрос шёл по "),t("strong",[e._v("http")])]),e._v(" "),t("ol",[t("li",[t("p",[e._v("Переименуем файл "),t("strong",[e._v("/plugins/api-context.js")]),e._v(" в "),t("strong",[e._v("/plugins/api-context.client.js")])])]),e._v(" "),t("li",[t("p",[e._v("изменим имя файла в настройках /nuxt.config.js")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('  plugins: ["~/plugins/api-context.client.js"]\n')])])]),t("p",[e._v("Теперь контекст "),t("strong",[e._v("this.$api")]),e._v(" доступен только для клиентского кода")])]),e._v(" "),t("li",[t("p",[e._v("создадим контекст "),t("strong",[e._v("this.$api")]),e._v(" для прямого вызова контроллеров на сервере")]),e._v(" "),t("p",[e._v("/plugins/api-context.server.js")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('export default (context, inject) => {\n  inject("api", async (controller, method, params) => {\n    try {\n      let api = require("../api/" + controller.replace(/^\\/+|\\/+$|\\.+/g, ""));\n      return await api[method](params);\n    } catch (e) {\n      console.error(e);\n      throw e;\n    }\n  });\n};\n')])])])]),e._v(" "),t("li",[t("p",[e._v("подключим серверный плагин")]),e._v(" "),t("p",[e._v("/nuxt.config.js")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('  plugins: [\n    "~/plugins/api-context.client.js",\n    "~/plugins/api-context.server.js"\n  ]\n')])])])])]),e._v(" "),t("p",[e._v("Теперь функция "),t("strong",[e._v("this.$api")]),e._v(" на сервере будет напрямую вызывать метод контроллера, а на клиенте "),t("strong",[e._v("this.$api")]),e._v(" отправлять "),t("strong",[e._v("http запрос")]),e._v(" через "),t("strong",[e._v("axios")]),e._v(".")]),e._v(" "),t("p",[e._v("Код")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('  async fetch() {\n    this.users = await this.$api("users", "index");\n  },\n')])])]),t("p",[e._v("при рендере на сервере, не будет выполнять "),t("strong",[e._v("http запрос")]),e._v(" на себя же, а просто подключит через "),t("strong",[e._v("require")]),e._v(" файл "),t("strong",[e._v("/api/users.js")]),e._v(" и вызовет метод "),t("strong",[e._v("index()")]),e._v(", т.е. не будут выполняться пункты с 4-13, а выполнится только 10.")]),e._v(" "),t("p",[e._v("Однако когда клиент в браузере нажмёт кнопку "),t("strong",[e._v("Refresh")]),e._v(", то те же самые данные запросятся через "),t("strong",[e._v("http")]),e._v(".")]),e._v(" "),t("p",[e._v("Вот полный код: "),t("a",{attrs:{href:"https://codesandbox.io/s/codesandbox-nuxt-pbriw",target:"_blank",rel:"noopener noreferrer"}},[e._v("codesandbox.io/s/codesandbox-nuxt-pbriw"),t("OutboundLink")],1)]),e._v(" "),t("h3",{attrs:{id:"тестирование-производительности"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#тестирование-производительности"}},[e._v("#")]),e._v(" Тестирование производительности")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://codesandbox.io/s/codesandbox-nuxt-rzdyw",target:"_blank",rel:"noopener noreferrer"}},[e._v("codesandbox.io/s/codesandbox-nuxt-rzdyw"),t("OutboundLink")],1)]),e._v(" "),t("ol",[t("li",[t("p",[e._v("Для исключения влияния скорости внешних соединений, я заменил получение данных, на статичные данные:")]),e._v(" "),t("p",[e._v("/api/users.js")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('// we can get data from any DB\nasync function getDataFromDB() {\n  return {\n    page: 1,\n    per_page: 6,\n    total: 12,\n    total_pages: 2,\n    data: [\n      {\n        id: 1,\n        email: "george.bluth@reqres.in",\n        first_name: "George",\n        last_name: "Bluth",\n        avatar:\n          "https://s3.amazonaws.com/uifaces/faces/twitter/calebogden/128.jpg"\n      },\n      {\n        id: 2,\n        email: "janet.weaver@reqres.in",\n        first_name: "Janet",\n        last_name: "Weaver",\n        avatar:\n          "https://s3.amazonaws.com/uifaces/faces/twitter/josephstein/128.jpg"\n      },\n      {\n        id: 3,\n        email: "emma.wong@reqres.in",\n        first_name: "Emma",\n        last_name: "Wong",\n        avatar:\n          "https://s3.amazonaws.com/uifaces/faces/twitter/olegpogodaev/128.jpg"\n      },\n      {\n        id: 4,\n        email: "eve.holt@reqres.in",\n        first_name: "Eve",\n        last_name: "Holt",\n        avatar:\n          "https://s3.amazonaws.com/uifaces/faces/twitter/marcoramires/128.jpg"\n      },\n      {\n        id: 5,\n        email: "charles.morris@reqres.in",\n        first_name: "Charles",\n        last_name: "Morris",\n        avatar:\n          "https://s3.amazonaws.com/uifaces/faces/twitter/stephenmoon/128.jpg"\n      },\n      {\n        id: 6,\n        email: "tracey.ramos@reqres.in",\n        first_name: "Tracey",\n        last_name: "Ramos",\n        avatar:\n          "https://s3.amazonaws.com/uifaces/faces/twitter/bigmancho/128.jpg"\n      }\n    ],\n    ad: {\n      company: "StatusCode Weekly",\n      url: "http://statuscode.org/",\n      text:\n        "A weekly newsletter focusing on software development, infrastructure, the server, performance, and the stack end of things."\n    }\n  };\n  /*\n  return (await require("axios").get(`https://reqres.in/api/users?page=1`))\n    .data;\n  */\n}\n....\n')])])])]),e._v(" "),t("li",[t("p",[e._v("Изменим вызов api на сервере, добавим возможность получения данных принудительно через "),t("strong",[e._v("http")]),e._v(" и признак серверных данных")]),e._v(" "),t("p",[e._v("/plugins/api-context.server.js")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('export default (context, inject) => {\n  inject("server", () => true);\n  inject("api", async (controller, method, params) => {\n    try {\n      if (params && params.httpcall) {\n        return await context.$axios["$" + (params ? "post" : "get")](\n          "/api/" + controller + "/" + method,\n          params\n        );\n      }\n      let api = require("../api/" + controller.replace(/^\\/+|\\/+$|\\.+/g, ""));\n      return await api[method](params);\n    } catch (e) {\n      console.error(e);\n      throw e;\n    }\n  });\n};\n')])])])]),e._v(" "),t("li",[t("p",[e._v("На странице "),t("strong",[e._v("index.vue")]),e._v(" в методе "),t("strong",[e._v("fetch")]),e._v(" асинхронно вызовем api 50 раз внутренним способом")]),e._v(" "),t("p",[e._v("/pages/index.vue")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('  async fetch() {\n    let start = new Date();\n    let promises = [];\n    let callNum = 50;\n    for (let i = 0; i < callNum; i++) {\n      promises.push(this.$api("users", "index"));\n    }\n\n    let arr = await Promise.all(\n      promises.map(async p => {\n        return await p;\n      })\n    );\n\n    let res = [];\n    for (let r of arr) {\n      res = res.concat(r);\n    }\n\n    this.users = res;\n    this.fetchType =\n      (this.$server && this.$server() ? "Server internal" : "Client http") +\n      " API call";\n    this.fetchTime = new Date() - start;\n  },\n')])])])]),e._v(" "),t("li",[t("p",[e._v("А на странице "),t("strong",[e._v("httpcall.vue")]),e._v(" в методе "),t("strong",[e._v("fetch")]),e._v(" асинхронно вызовем api 50 раз через http")]),e._v(" "),t("p",[e._v("/pages/httpcall.vue")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('...\n      promises.push(this.$api("users", "index", { httpcall: true }));\n...\n    this.fetchType =\n      (this.$server && this.$server() ? "Server http" : "Client http") +\n      " API call";\n...\n')])])])]),e._v(" "),t("li",[t("p",[e._v("Теперь сравним время выполнения "),t("a",{attrs:{href:"https://rzdyw.sse.codesandbox.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("rzdyw.sse.codesandbox.io"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("Server internal API call rendering fetch time: 1ms"),t("br"),e._v("\nвремя от 0ms до максимум 2ms")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://rzdyw.sse.codesandbox.io/httpcall",target:"_blank",rel:"noopener noreferrer"}},[e._v("rzdyw.sse.codesandbox.io/httpcall"),t("OutboundLink")],1),t("br"),e._v("\nServer http API call rendering fetch time: 71ms"),t("br"),e._v("\nвремя от 46ms до максимум 1059ms"),t("br"),e._v("\nи несколько раз сервер вообще падал с ошибкой")]),e._v(" "),t("p",[t("code",[e._v("RangeError Maximum call stack size exceeded")])])])]),e._v(" "),t("p",[e._v("Вот полный пример — "),t("a",{attrs:{href:"https://codesandbox.io/s/codesandbox-nuxt-rzdyw",target:"_blank",rel:"noopener noreferrer"}},[e._v("codesandbox.io/s/codesandbox-nuxt-rzdyw"),t("OutboundLink")],1)]),e._v(" "),t("h3",{attrs:{id:"итого-часть-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#итого-часть-2"}},[e._v("#")]),e._v(" Итого Часть 2")]),e._v(" "),t("ul",[t("li",[e._v("Минимальными изменениями можно ускорить серверный рендеринг более чем в 50 раз, на живом примере рендеринг страницы у меня ускорялся в ~1.7 раза")]),e._v(" "),t("li",[e._v("Существенно сократился расход ресурсов Node HTTP сервера")]),e._v(" "),t("li",[e._v("В оптимизированном виде единственный инстанс Nuxt'а должен выдержать нагрузку небольших и средних проектов")])])])}),[],!1,null,null,null);t.default=s.exports}}]);
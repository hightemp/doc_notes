(window.webpackJsonp=window.webpackJsonp||[]).push([[185],{459:function(e,t,o){"use strict";o.r(t);var r=o(14),a=Object(r.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("div",{pre:!0},[t("p",[e._v("https://blog.jetbrains.com/go/2021/06/09/how-to-use-go-embed-in-go-1-16/")]),e._v(" "),t("p",[e._v("One of the most anticipated features of Go 1.16 is the support for embedding files and folders into the application binary at compile-time without using an external tool. This feature is also known as "),t("em",[e._v("go:embed")]),e._v(", and it gets its name from the compiler directive that makes this functionality possible: "),t("em",[e._v("//go:embed")]),e._v(".")]),e._v(" "),t("p",[e._v("With it, you can embed all web assets required to make a frontend application work. The build pipeline will simplify since the embedding step does not require any additional tooling to get all static files needed in the binary. At the same time, the deployment pipeline is predictable since you don’t need to worry about deploying the static files and the problems that come with that, such as: making sure the relative paths are what the binary expects, the working directory is the correct one, the application has the proper permissions to read the files, etc. You just deploy the application binary and start it, and everything else works.")]),e._v(" "),t("p",[e._v("Let’s see how we can use this feature to our advantage with an example webserver:")]),e._v(" "),t("ul",[t("li",[e._v("First, create a new Go modules project in GoLand, and make sure you use Go 1.16 or newer. The "),t("em",[e._v("go")]),e._v(" directive in the "),t("em",[e._v("go.mod")]),e._v(" file must be set to Go 1.16 or higher too.")])]),e._v(" "),t("p",[e._v("module goembed.demo")]),e._v(" "),t("p",[e._v("go 1.16")]),e._v(" "),t("ul",[t("li",[e._v("Our "),t("em",[e._v("main.go")]),e._v(" file should look like this:")])]),e._v(" "),t("p",[e._v("package main")]),e._v(" "),t("p",[e._v("import (")]),e._v(" "),t("p",[e._v('"embed"')]),e._v(" "),t("p",[e._v('"html/template"')]),e._v(" "),t("p",[e._v('"log"')]),e._v(" "),t("p",[e._v('"net/http"')]),e._v(" "),t("p",[e._v(")")]),e._v(" "),t("p",[e._v("var (")]),e._v(" "),t("p",[e._v("//go:embed resources")]),e._v(" "),t("p",[e._v("res embed.FS")]),e._v(" "),t("p",[e._v("pages = map[string]string{")]),e._v(" "),t("p",[e._v('"/": "resources/index.gohtml",')]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v(")")]),e._v(" "),t("p",[e._v("func main() {")]),e._v(" "),t("p",[e._v('http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {')]),e._v(" "),t("p",[e._v("page, ok := pages[r.URL.Path]")]),e._v(" "),t("p",[e._v("if !ok {")]),e._v(" "),t("p",[e._v("w.WriteHeader(http.StatusNotFound)")]),e._v(" "),t("p",[e._v("return")]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v("tpl, err := template.ParseFS(res, page)")]),e._v(" "),t("p",[e._v("if err != nil {")]),e._v(" "),t("p",[e._v('log.Printf("page %s not found in pages cache...", r.RequestURI)')]),e._v(" "),t("p",[e._v("w.WriteHeader(http.StatusInternalServerError)")]),e._v(" "),t("p",[e._v("return")]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v('w.Header().Set("Content-Type", "text/html")')]),e._v(" "),t("p",[e._v("w.WriteHeader(http.StatusOK)")]),e._v(" "),t("p",[e._v("data := map[string]interface{}{")]),e._v(" "),t("p",[e._v('"userAgent": r.UserAgent(),')]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v("if err := tpl.Execute(w, data); err != nil {")]),e._v(" "),t("p",[e._v("return")]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v("})")]),e._v(" "),t("p",[e._v("http.FileServer(http.FS(res))")]),e._v(" "),t("p",[e._v('log.Println("server started...")')]),e._v(" "),t("p",[e._v('err := http.ListenAndServe(":8088", nil)')]),e._v(" "),t("p",[e._v("if err != nil {")]),e._v(" "),t("p",[e._v("panic(err)")]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("ul",[t("li",[e._v("Next, create a new "),t("em",[e._v("resources/index.gohtml")]),e._v(" file like the one below:")])]),e._v(" "),t("html",{pre:!0,attrs:{lang:"en"}},[t("head",[t("meta",{pre:!0,attrs:{charset:"UTF-8"}}),e._v(" "),t("title",[e._v("go:embed demo")])]),e._v(" "),t("body",[t("div",[t("h1",[e._v("Hello, {{ .userAgent }}!")]),e._v(" "),t("p",[e._v("If you see this, then go:embed worked!")])])])]),e._v(" "),t("ul",[t("li",[e._v("Finally, create a file called "),t("em",[e._v("check.http")]),e._v(" at the root of the project. This will reduce the time it takes to test our code by making repeatable requests from GoLand rather than using the browser.")])]),e._v(" "),t("p",[e._v("GET http://localhost:8088/")]),e._v(" "),t("p",[t("strong",[t("em",[e._v("Note:")])]),e._v(" If you need to, you can download a newer version of Go using GoLand either while creating the project or via "),t("em",[e._v("Settings/Preferences | Go | GOROOT | + | Download …")])]),e._v(" "),t("p",[e._v("This is how the project layout should look:")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://blog.jetbrains.com/wp-content/uploads/2021/06/project-layout-1.png",alt:""}})]),e._v(" "),t("p",[e._v("If we run this project, then test the request from the "),t("em",[e._v("check.http")]),e._v(" file against our server, we get what we’d expect: an HTML response that contains our Hello message and the “Apache-HttpClient” user agent.")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://resources.jetbrains.com/storage/products/blog/wp-content/uploads/GoLand/Go%20Embed%20support/run%20http%20server%20and%20check.png",alt:""}}),e._v("GIF")]),e._v(" "),t("p",[e._v("At first, this might not look different than any other server responding to a request with our template code.")]),e._v(" "),t("p",[e._v("However, if we change the code in the template without restarting the server, we’ll quickly notice that our output will not change unless we rebuild the binary. We can even remove the template, move the binary, or change its running directory, and the result will be similar. How does this work, then?")]),e._v(" "),t("h2",{pre:!0,attrs:{id:"a-quick-look-at-how-go-embed-works"}},[t("a",{pre:!0,attrs:{class:"header-anchor",href:"#a-quick-look-at-how-go-embed-works"}},[e._v("#")]),e._v(" A quick look at how go:embed works")]),e._v(" "),t("p",[e._v("We can isolate a few parts of our code that are involved in using this feature.")]),e._v(" "),t("p",[e._v("We’ll start with the imports section, where we can see that we are using a new package called "),t("em",[e._v("embed")]),e._v(". This package, combined with the comment "),t("em",[e._v("//go:embed")]),e._v(", a "),t("a",{pre:!0,attrs:{href:"https://golang.org/cmd/compile/#hdr-Compiler_Directives",target:"_blank",rel:"noopener noreferrer"}},[e._v("compiler directive"),t("OutboundLink",{pre:!0})],1),e._v(", tells the compiler that we intend to embed files or folders in the resulting binary.")]),e._v(" "),t("p",[e._v("You need to follow this directive with a variable declaration to serve as the container for the embedded contents. The type of the variable can be a string, a slice of bytes, or "),t("a",{pre:!0,attrs:{href:"https://pkg.go.dev/embed#FS",target:"_blank",rel:"noopener noreferrer"}},[t("em",[e._v("embed.FS")]),t("OutboundLink",{pre:!0})],1),e._v(" type. If you embed resources using the "),t("em",[e._v("embed.FS")]),e._v(" type, they also get the benefit of being read-only and goroutine-safe.")]),e._v(" "),t("h2",{pre:!0,attrs:{id:"goland-support-for-go-embed"}},[t("a",{pre:!0,attrs:{class:"header-anchor",href:"#goland-support-for-go-embed"}},[e._v("#")]),e._v(" GoLand support for go:embed")]),e._v(" "),t("p",[e._v("GoLand completion features come in handy while using the embed directive, helping you write the paths/pattern.")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://resources.jetbrains.com/storage/products/blog/wp-content/uploads/GoLand/Go%20Embed%20support/completion%20in%20go%20embed%20directives.png",alt:""}}),e._v("GIF")]),e._v(" "),t("p",[e._v("You can also navigate to the embedded resource from the editor.")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://resources.jetbrains.com/storage/products/blog/wp-content/uploads/GoLand/Go%20Embed%20support/navigate%20to%20definition.png",alt:""}}),e._v("GIF")]),e._v(" "),t("p",[e._v("What if you want to change the name of the resource you’ve embedded? Or perhaps you want to change the whole directory structure? GoLand has you covered here too:")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://resources.jetbrains.com/storage/products/blog/wp-content/uploads/GoLand/Go%20Embed%20support/refactoring%20support%20for%20go%20embed%20directive.png",alt:""}}),e._v("GIF")]),e._v(" "),t("p",[t("strong",[e._v("Pro tip:")]),e._v(" You can embed resources into the binary from any file, not just the main one. This means that you can ship modules with resources that are transparently compiled into the end application. "),t("br"),e._v(" "),t("strong",[e._v("Pro tip:")]),e._v(" You can use the embedding feature in test files too! Try it out and let us know what you think.")]),e._v(" "),t("h2",{pre:!0,attrs:{id:"limitations"}},[t("a",{pre:!0,attrs:{class:"header-anchor",href:"#limitations"}},[e._v("#")]),e._v(" Limitations")]),e._v(" "),t("p",[e._v("Embedding empty folders is not supported. Embedding symlinks is not currently supported either.")]),e._v(" "),t("p",[e._v("If you don’t plan to use "),t("em",[e._v("embed.FS")]),e._v(", then you can use "),t("em",[e._v("//go:embed")]),e._v(" to embed a single file. To do so, you must still import the "),t("em",[e._v("embed")]),e._v(" package, but only "),t("a",{pre:!0,attrs:{href:"https://golang.org/doc/effective_go#blank_import",target:"_blank",rel:"noopener noreferrer"}},[e._v("for side effects"),t("OutboundLink",{pre:!0})],1),e._v(".")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://resources.jetbrains.com/storage/products/blog/wp-content/uploads/GoLand/Go%20Embed%20support/fix%20missing%20embed%20directive.png",alt:""}}),e._v("GIF")]),e._v(" "),t("p",[e._v("The embedding directive must not contain a space between the comment and “"),t("em",[e._v("go:")]),e._v("“.")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://blog.jetbrains.com/wp-content/uploads/2021/06/go-embed-with-spaces-2-1.png",alt:""}})]),e._v(" "),t("p",[e._v("The embedded paths must exist and match the pattern. Otherwise, the compiler will abort with an error.")]),e._v(" "),t("p",[t("img",{pre:!0,attrs:{src:"https://blog.jetbrains.com/wp-content/uploads/2021/06/file-pattern-not-found-1.png",alt:""}})]),e._v(" "),t("h2",{pre:!0,attrs:{id:"conclusion"}},[t("a",{pre:!0,attrs:{class:"header-anchor",href:"#conclusion"}},[e._v("#")]),e._v(" Conclusion")]),e._v(" "),t("p",[e._v("That’s it for now! We learned why and how to use Go 1.16’s new embedding feature, took a look at how it works, and considered some caveats to remember when using it. We’ve also seen how GoLand helps you work with this feature and provides features such as completion, error detection, and more.")]),e._v(" "),t("p",[e._v("We are looking forward to hearing from you about how you use this feature. You can leave us a note in the comments section below, "),t("a",{pre:!0,attrs:{href:"https://twitter.com/GoLandIDE",target:"_blank",rel:"noopener noreferrer"}},[e._v("on Twitter"),t("OutboundLink",{pre:!0})],1),e._v(", "),t("a",{pre:!0,attrs:{href:"https://app.slack.com/client/T029RQSE6/C3FJ8M2PN/",target:"_blank",rel:"noopener noreferrer"}},[e._v("on the Gophers Slack"),t("OutboundLink",{pre:!0})],1),e._v(", or "),t("a",{pre:!0,attrs:{href:"https://youtrack.jetbrains.com/issues/Go",target:"_blank",rel:"noopener noreferrer"}},[e._v("our issue tracker"),t("OutboundLink",{pre:!0})],1),e._v(" if you’d like to let us know about additional features you’d like to see related to this or other Go functionality.")])])])}),[],!1,null,null,null);t.default=a.exports}}]);
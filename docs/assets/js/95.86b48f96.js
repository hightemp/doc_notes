(window.webpackJsonp=window.webpackJsonp||[]).push([[95],{367:function(t,e,a){"use strict";a.r(e);var r=a(14),s=Object(r.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("https://wiki.dieg.info/tcpdump")]),t._v(" "),e("h1",{attrs:{id:"tcpdump"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tcpdump"}},[t._v("#")]),t._v(" tcpdump")]),t._v(" "),e("p",[t._v("Homepage:  "),e("a",{attrs:{href:"http://www.tcpdump.org/",title:"http://www.tcpdump.org",target:"_blank",rel:"noopener noreferrer"}},[t._v("Official web site of tcpdump"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("Утилита  "),e("strong",[t._v("tcpdump")]),t._v("  относится к числу так называемых «снифферов» — программ предназначенных для перехвата сетевого трафика. Одним словом, tcpdump предназначен для подслушивания. Разрабо­тан Группой сетевых исследований (Network Reseach Group, NRG) Отдела инфор­мационных и вычислительных технологий (Information and Computing Sciences Division, ICSD) в Национальной лаборатории Лоренс Беркли (Lawrence Berkeley National Laboratory, LBNL).")]),t._v(" "),e("p",[t._v("tcpdump не единственный  "),e("a",{attrs:{href:"https://wiki.dieg.info/sniffer",title:"sniffer",target:"_blank",rel:"noopener noreferrer"}},[t._v("Сетевые анализаторы снифферы"),e("OutboundLink")],1),t._v(", которым может пользоваться администратор. Кроме tcpdump можно обратить внимание на такие программы, как:")]),t._v(" "),e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://wiki.dieg.info/wireshark",title:"wireshark",target:"_blank",rel:"noopener noreferrer"}},[t._v("Wireshark"),e("OutboundLink")],1),t._v("  (бывший ethereal) —  "),e("a",{attrs:{href:"https://wiki.dieg.info/sniffer",title:"sniffer",target:"_blank",rel:"noopener noreferrer"}},[t._v("Сетевые анализаторы снифферы"),e("OutboundLink")],1),t._v("  с графическим интерфейсом, который может обрабатывать дампы сделанные программой tcpdump")])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://wiki.dieg.info/ngrep",title:"ngrep",target:"_blank",rel:"noopener noreferrer"}},[t._v("ngrep"),e("OutboundLink")],1)])])]),t._v(" "),e("p",[t._v("tcpdump работает при помощи интерфейса bpf (Berkeley Packet Filter). Если поддержку этого устройства отключить, сниффинг в  "),e("a",{attrs:{href:"https://wiki.dieg.info/bsd",title:"bsd",target:"_blank",rel:"noopener noreferrer"}},[t._v("BSD"),e("OutboundLink")],1),t._v("  окажется невозможен. Права на запуск программы tcpdump определяются правами доступа к устройсву bpf (/dev/bpf0). Эти права можно регулировать через devfs. Если вы предоставляете, например, группе operator права на чтение из этого устройства, то это значит, что все члены этой группы смогут перехватывать любой трафик, в том числе трафик суперпользователя.")]),t._v(" "),e("p",[t._v("Если программа tcpdump вызвана для прослушивания некоторого интерфейса, она переводит его в «promiscuous mode» — «неразборчивый режим». В этом режиме интерфейс ловит вообще все пакеты, которые до него добрались, а не только пакеты адресованные непосредственно ему. Таким образом, если сеть собрана не на коммураторах (switch), а на репитерах (hub), то tcpdump позволит перехватить трафик между посторонними машинами, т.е. подслушать разговор двух сторонних машин. Сказанное не означает, что перехват трафика невозможен в сети собранной на коммутаторах. Впрочем, интерфейс можно и не переводить в promiscous mode, если передать программе аргумент -p.")]),t._v(" "),e("h2",{attrs:{id:"tcpdump-для-voip-sip-h-323"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tcpdump-для-voip-sip-h-323"}},[t._v("#")]),t._v(" tcpdump для VoIP SIP H.323")]),t._v(" "),e("p",[t._v("Ключ -w применяется для записи данных в отдельный файл. Прочитать это файл можно применяя ключи -r и -X(показать заголовки), например:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -r tcpdumplog\n# tcpdump -X -r tcpdumplog\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -i eth0 -n port 5060 -w mbill\nor\n# tcpdump -i eth0 -n -s 0 port 5060 -vvv -w /home/capture_file_name\nor \n# tcpdump -i eth0 -n host 89.31.241.2 -vvv -w /home/textcall\n")])])]),e("p",[t._v("Анализирует траффик удаленно через SSH с помощью  "),e("a",{attrs:{href:"https://wiki.dieg.info/wireshark",title:"wireshark",target:"_blank",rel:"noopener noreferrer"}},[t._v("Wireshark"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ssh root@HOST tcpdump -U -s0 -w - 'not port 22' | wireshark -k -i -\n")])])]),e("p",[t._v("UDP трафик с и на IP xxx.xxx.xxx.251 destined for port 5060:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -nnvvS udp and host xxx.xxx.xxx.251 and dst port 5060\n")])])]),e("p",[t._v("Записать в файл mbill251 весь трафик с хоста xxx.xxx.xxx.251 за исключением трафика ssh")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -n -i eth0 host xxx.xxx.xxx.251 -vvv and not port 22 -w /home/mbill251\n")])])]),e("p",[t._v("Прослушать порт 5060 с ip xxx.xxx.xxx.251")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump -i eth0 -n -s 0 port 5060 and host xxx.xxx.xxx.251 -vvv -w /usr/local/tcpdumplog/log\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump -i eth0 -n -s 0 port 1720 and host xxx.xxx.xxx.251 -vvv -w /usr/local/tcpdumplog\n")])])]),e("p",[t._v("H.323 сигналинг ловим с двух IP. В таком виде с двух IP отказалось снимать, мож"),e("strong",[t._v("ет быть OR нужно бы")]),t._v("ло поставить.")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -i eth0 -n -s 0 port 1720 and host xxx.xxx.164.1 and host xxx.xxx.107.1 -vvv -w /usr/local/tcpdumplog/logfile\n")])])]),e("h2",{attrs:{id:"tcpdump-packet-filter-firewall-pf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tcpdump-packet-filter-firewall-pf"}},[t._v("#")]),t._v(" tcpdump Packet Filter Firewall (PF)")]),t._v(" "),e("p",[t._v("Просмотреть лог  "),e("a",{attrs:{href:"https://wiki.dieg.info/packet_filter_firewall_pf",title:"packet_filter_firewall_pf",target:"_blank",rel:"noopener noreferrer"}},[t._v("Packet Filter Firewall (PF) (обновление 2018.08)"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -nettti pflog0\n# tcpdump -netttr /var/log/pflog\n")])])]),e("h2",{attrs:{id:"примеры-использования-tcpdump"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#примеры-использования-tcpdump"}},[t._v("#")]),t._v(" Примеры использования tcpdump")]),t._v(" "),e("p",[t._v("перечислить доступные интерфейсы (которые можно прослушивать при помощи опции -i)")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump -D\n")])])]),e("p",[t._v("посмотреть трафик одного хоста:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump host 1.2.3.4\n")])])]),e("p",[t._v("посмотреть трафик на порте:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump src port 80\n")])])]),e("p",[t._v("посмотреть IP трафик на хост:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump ip host 1.2.3.4\n")])])]),e("p",[t._v("посмотреть ARP трафик на хост:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump arp host 1.2.3.4\n")])])]),e("p",[t._v("посмотреть RARP трафик на хост:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump rarp host 1.2.3.4\n")])])]),e("p",[t._v("посмотреть трафик, кроме хоста unixserver:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump not host unixserver\n")])])]),e("p",[t._v("посмотреть трафик на server1 и server2")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump host server1 or host server2\n")])])]),e("p",[t._v("посмотреть содержимое пакетов на интерфейсе tun0 на хост ya.ru")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump -X -i tun0 host ya.ru\n")])])]),e("p",[t._v("подсмотреть номера и пароли к icq")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump -X -i fxp1 port aol\n")])])]),e("p",[t._v("посмотреть содержимое пакетов на интерфейсе tun0 на хост ya.ru, при этом прочитать из каждого пакета по 1500 байт и не преобразовывать IP в имя хоста")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("tcpdump -X -s 1500 -n -i tun0 host ya.ru\n")])])]),e("h2",{attrs:{id:"примеры-использования-tcpdump-and-or-except"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#примеры-использования-tcpdump-and-or-except"}},[t._v("#")]),t._v(" Примеры использования tcpdump AND OR EXCEPT")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("AND \nand or &&\nOR \nor or ||\nEXCEPT \nnot or !\n")])])]),e("p",[t._v("TCP traffic from 10.5.2.3 destined for port 3389:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -nnvvS tcp and src 10.5.2.3 and dst port 3389\n")])])]),e("p",[t._v("Traffic originating from the 192.168 network headed for the 10 or 172.16 networks:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -nvX src net 192.168.0.0/16 and dst net 10.0.0.0/8 or 172.16.0.0/16\n")])])]),e("p",[t._v("Non-ICMP traffic destined for 192.168.0.2 from the 172.16 network:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -nvvXSs 1514 dst 192.168.0.2 and src net 172.16.0.0/16 and not icmp\n")])])]),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -nvvvpi rl0 tcp and not port ssh and not port smtp\n")])])]),e("h2",{attrs:{id:"проблема-arplookup-0-0-0-0-failed-host-is-not-on-local-network"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#проблема-arplookup-0-0-0-0-failed-host-is-not-on-local-network"}},[t._v("#")]),t._v(" Проблема +arplookup 0.0.0.0 failed: host is not on local network")]),t._v(" "),e("p",[t._v("Лечение: запускаем команду и ищем MAC c ошибкой")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -vvv -n -l -e arp | grep 0.0.0.0\n...\n16:43:57.407018 00:0e:89:1d:cc:87 > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 60: arp who-has 86.90.285.175 (00:50:fc:f0:3e:e9) tell 0.0.0.0\n...\n")])])]),e("p",[e("a",{attrs:{href:"http://www.mail-archive.com/freebsd-questions@freebsd.org/msg191545.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("arplookup 0.0.0.0 failed: host is not on local network"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"http://en.wikipedia.org/wiki/0.0.0.0",target:"_blank",rel:"noopener noreferrer"}},[t._v("Default route 0.0.0.0"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -vvv -n -l -e arp\n# tcpdump -i rl1 -vvv -n -l -e arp\n")])])]),e("p",[e("strong",[t._v("arpdig")]),t._v("  – dig an interface for arp responses. Выводит соответствие между IP и MAC. Пример использования:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# arpdig 195.143.151.1/28\n")])])]),e("p",[t._v("gratuitous arp - самообращенные запросы. При таком запросе инициатор формирует пакет, где в качестве IP используется его собственный адрес.")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://wiki.dieg.info/arping",title:"arping",target:"_blank",rel:"noopener noreferrer"}},[t._v("Использование утилиты arping"),e("OutboundLink")],1),t._v("  -  "),e("a",{attrs:{href:"https://wiki.dieg.info/arp",title:"arp",target:"_blank",rel:"noopener noreferrer"}},[t._v("Работа с ARP протоколом: очистка таблицы"),e("OutboundLink")],1),t._v('  level "ping" utility Пример использования:')]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('for /l %i in (1,1,254) do ping -n 1 -w 1 192.168.1.%i\narp -a | find "арп"\n')])])]),e("h2",{attrs:{id:"wireshark-packet-size-limited-during-capture"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#wireshark-packet-size-limited-during-capture"}},[t._v("#")]),t._v(" Wireshark: Packet size limited during capture")]),t._v(" "),e("p",[t._v("Файлы tcpdump совместимы с  "),e("a",{attrs:{href:"https://wiki.dieg.info/wireshark",title:"wireshark",target:"_blank",rel:"noopener noreferrer"}},[t._v("Wireshark"),e("OutboundLink")],1),t._v('. Запуская ее с параметром -w filename, мы получаем файл, содержащий нужный нам сетевой трафик. К сожалению, по умолчанию в tcpdump каждый пакет ограничивается 96ю байтами (которых, как правило, достаточно для анализа любых пакетов). Однако если нужно залезть глубже и смотреть всё содержимое пакетов, нужно использовать команду -s size (где size - размер пакетов, которые нужно ловить). Для обычного ethernet\'а размер пакетов равен 1500, для "разогнанного" гигабитного etherneta - порой до 65к.')]),t._v(" "),e("p",[t._v("Итого, имеем следующую команду:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# tcpdump -s 1500 -w filename\n")])])]),e("p",[t._v("И используем ее для того, чтобы можно было создать полный дамп сетевого трафика, который можно смотреть в Wireshark без сообщений вида  "),e("strong",[t._v("Packet size limited during capture")])])])}),[],!1,null,null,null);e.default=s.exports}}]);